#!/bin/bash

# AIvsAI 一键安装脚本
# 支持：直接运行 ./setup 或双击 "安装 AIvsAI.app"

set -e

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# 获取项目绝对路径
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

clear
echo -e "${GREEN}╔══════════════════════════════════════╗${NC}"
echo -e "${GREEN}║     AIvsAI 一键安装程序              ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════╝${NC}"
echo ""

# 检查 Rust/Cargo
if ! command -v cargo &> /dev/null; then
    echo -e "${YELLOW}⚠ 未检测到 Rust，正在自动安装...${NC}"
    echo ""
    
    # 自动安装 Rust
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
    
    echo -e "${GREEN}✓ Rust 安装完成${NC}"
    echo ""
else
    echo -e "${GREEN}✓ Rust 已安装${NC}"
fi

# 检查依赖
echo -e "${BLUE}→ 检查依赖...${NC}"
cd "$PROJECT_DIR"

# 编译安装
echo -e "${BLUE}→ 编译安装 AIvsAI...${NC}"
cargo build --release 2>&1 | while read line; do
    echo "  $line"
done

cargo install --path . --force 2>&1 | tail -5

echo -e "${GREEN}✓ 编译安装完成${NC}"
echo ""

# 检测 shell
if [[ "$SHELL" == *"zsh"* ]]; then
    SHELL_RC="$HOME/.zshrc"
elif [[ "$SHELL" == *"bash"* ]]; then
    SHELL_RC="$HOME/.bashrc"
else
    SHELL_RC="$HOME/.profile"
fi

# 添加 alias
echo -e "${BLUE}→ 配置快捷命令...${NC}"

# 删除旧 alias（如果存在）
sed -i '' '/# AIvsAI aliases/d' "$SHELL_RC" 2>/dev/null || true
sed -i '' '/alias aivsai/d' "$SHELL_RC" 2>/dev/null || true

# 添加新 alias
cat >> "$SHELL_RC" << EOF

# AIvsAI aliases
alias aivsai='cd $PROJECT_DIR && ai_vs_ai'
alias aivsai-cd='cd $PROJECT_DIR/conversations && ls -la'
EOF

echo -e "${GREEN}✓ 快捷命令已配置${NC}"
echo ""

# 创建 conversations 目录
mkdir -p "$PROJECT_DIR/conversations"
echo -e "${GREEN}✓ 对话记录目录已创建${NC}"
echo ""

# 完成提示
echo -e "${GREEN}╔══════════════════════════════════════╗${NC}"
echo -e "${GREEN}║     安装完成！                       ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════╝${NC}"
echo ""
echo -e "${YELLOW}使用方法：${NC}"
echo ""
echo -e "  1. ${BLUE}关闭此终端窗口${NC}"
echo -e "  2. ${BLUE}打开新的终端窗口${NC}"
echo -e "  3. 输入 ${GREEN}aivsai${NC} 启动程序"
echo -e "  4. 输入 ${GREEN}aivsai-cd${NC} 查看对话记录"
echo ""
echo -e "${YELLOW}对话记录保存在：${NC}"
echo -e "  ${BLUE}$PROJECT_DIR/conversations/${NC}"
echo ""

# 询问是否立即启动
read -p "是否立即启动 AIvsAI? (y/n): " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${GREEN}启动 AIvsAI...${NC}"
    cd "$PROJECT_DIR" && ai_vs_ai
else
    read -p "按回车键关闭..."
fi
